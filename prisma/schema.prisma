generator client {
    provider = "prisma-client-js"
    // You can add output if you want:
    // output = "../generated/prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL") // only for IDE linting
}

// ENUMS
enum Role {
    ADMIN
    TEACHER
    STUDENT
}

enum QType {
    MCQ
    MULTI
    TEXT
    NUMERIC
}

enum ExamStatus {
    DRAFT
    SCHEDULED
    ONGOING
    CLOSED
}

// SCHOOL & USERS
model School {
    id        Int      @id @default(autoincrement())
    name      String
    slug      String   @unique
    createdAt DateTime @default(now())
    config    Json?

    admins   User[]    @relation("SchoolAdmins")
    teachers User[]    @relation("SchoolTeachers")
    students Student[]
    subjects Subject[]
    exams    Exam[]
    tests    Test[]
    payments Payment[]
}

model User {
    id        Int      @id @default(autoincrement())
    uuid      String   @unique @default(uuid())
    email     String   @unique
    name      String?
    password  String
    role      Role
    createdAt DateTime @default(now())

    adminSchoolId Int?
    adminSchool   School? @relation("SchoolAdmins", fields: [adminSchoolId], references: [id])

    teacherSchoolId Int?
    teacherSchool   School? @relation("SchoolTeachers", fields: [teacherSchoolId], references: [id])

    student      Student?
    activityLogs ActivityLog[]
}

// STUDENTS
model Student {
    id        Int      @id @default(autoincrement())
    matricNo  String   @unique
    name      String
    createdAt DateTime @default(now())

    userId Int?  @unique
    user   User? @relation(fields: [userId], references: [id])

    schoolId Int
    school   School @relation(fields: [schoolId], references: [id])

    submissions  Submission[]
    progress     Progress[]
    leaderboards Leaderboard[]
}

// SUBJECTS & EXAMS
model Subject {
    id        Int      @id @default(autoincrement())
    name      String
    code      String
    createdAt DateTime @default(now())

    schoolId Int
    school   School @relation(fields: [schoolId], references: [id])

    exams    Exam[]
    tests    Test[]
    progress Progress[]
}

model Exam {
    id          Int        @id @default(autoincrement())
    title       String
    description String?
    status      ExamStatus @default(DRAFT)

    startTime   DateTime?
    endTime     DateTime?
    durationMin Int?

    shuffleQ    Boolean @default(true)
    shuffleOpt  Boolean @default(true)
    maxAttempts Int     @default(1)
    showResult  Boolean @default(true)

    createdAt DateTime @default(now())

    schoolId Int
    school   School @relation(fields: [schoolId], references: [id])

    subjectId Int?
    subject   Subject? @relation(fields: [subjectId], references: [id])

    questions    Question[]
    submissions  Submission[]
    leaderboards Leaderboard[]
    tests        Test[]
}

model Test {
    id          Int        @id @default(autoincrement())
    title       String
    description String?
    status      ExamStatus @default(DRAFT)

    startTime   DateTime?
    endTime     DateTime?
    durationMin Int?

    maxAttempts Int     @default(1)
    shuffleQ    Boolean @default(true)
    shuffleOpt  Boolean @default(true)
    showResult  Boolean @default(true)

    createdAt DateTime @default(now())

    schoolId Int
    school   School @relation(fields: [schoolId], references: [id])

    examId Int
    exam   Exam @relation(fields: [examId], references: [id])

    subjectId Int?
    subject   Subject? @relation(fields: [subjectId], references: [id])

    questions    Question[]
    submissions  Submission[]
    leaderboards Leaderboard[]
}

// QUESTIONS & OPTIONS
model Question {
    id          Int    @id @default(autoincrement())
    text        String
    type        QType
    mark        Float  @default(1)
    answerKey   Json?
    gradingRule Json?

    examId Int?
    exam   Exam? @relation(fields: [examId], references: [id])

    testId Int?
    test   Test? @relation(fields: [testId], references: [id])

    options Option[]
}

model Option {
    id        Int     @id @default(autoincrement())
    text      String
    isCorrect Boolean @default(false)

    questionId Int
    question   Question @relation(fields: [questionId], references: [id])
}

// SUBMISSIONS & RESULTS
model Submission {
    id        Int      @id @default(autoincrement())
    answers   Json
    score     Float?
    graded    Boolean  @default(false)
    breakdown Json?
    analytics Json?
    createdAt DateTime @default(now())

    studentId Int
    student   Student @relation(fields: [studentId], references: [id])

    examId Int?
    exam   Exam? @relation(fields: [examId], references: [id])

    testId Int?
    test   Test? @relation(fields: [testId], references: [id])
}

model Progress {
    id       Int   @id @default(autoincrement())
    average  Float
    attempts Int

    studentId Int
    student   Student @relation(fields: [studentId], references: [id])

    subjectId Int
    subject   Subject @relation(fields: [subjectId], references: [id])
}

model Leaderboard {
    id        Int      @id @default(autoincrement())
    score     Float
    rank      Int
    createdAt DateTime @default(now())

    examId Int?
    exam   Exam? @relation(fields: [examId], references: [id])

    testId Int?
    test   Test? @relation(fields: [testId], references: [id])

    studentId Int
    student   Student @relation(fields: [studentId], references: [id])
}

// ADMIN & AUDIT
model ActivityLog {
    id        Int      @id @default(autoincrement())
    action    String
    entity    String
    entityId  Int
    createdAt DateTime @default(now())

    userId Int
    user   User @relation(fields: [userId], references: [id])
}

// PAYMENTS
model Payment {
    id        Int      @id @default(autoincrement())
    amount    Float
    currency  String
    reference String   @unique
    status    String
    createdAt DateTime @default(now())

    schoolId Int
    school   School @relation(fields: [schoolId], references: [id])
}
